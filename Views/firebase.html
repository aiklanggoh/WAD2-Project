<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Database</title>

    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.js"></script>

    <!-- Vue -->
    <script src="https://unpkg.com/vue@next"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
</head>
<body>

    <!--Nav Bar-->
    <nav class="navbar navbar-expand-lg bg-light">
        <div class="container-fluid">
            <div class="d-flex">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo03" aria-controls="navbarTogglerDemo03" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <a class="navbar-brand mx-3" href="index">TriPPlaner</a>
            </div>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="itineraries.html">Browse Itineraries</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="plantrip.html">Plan Trip</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="activities.html">Activities</a>
                    </li>
                </ul>

                
                
            </div>
            <div class="d-flex align-items-center">
                <button type="button" class="btn btn-primary px-3 mb-1 me-2" aria-controls="#picker-editor">Login</button>
                <button type="button" class="btn btn-primary mb-1 me-lg-3" aria-controls="#picker-editor">Sign up</button>
            </div>
        </div>
    </nav>


    <h1 class="mt-5" id="target"></h1>
    Trip Name:<input type="text" id="tripName"><br>
    Number of Days:<input type="text" id="noDays"><br>

    <button name="insertBtn" id="insertBtn">Insert to DB</button> <br> <br> <br>

    <button id='btnLogin'>Google Login</button> 
    <button id='btnLogout'>Logout</button> 
    
    <hr> <h1 id='login'></h1>

    <span id="testresults"></span>
    <table class="table" id="plans">
        
    </table>




    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-analytics.js";
        import { getDatabase, ref, onValue, set, update, get, push, child } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-database.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBTz07CsUuC8llduTdGo_e81mWjQcdw8oI",
            authDomain: "wad2-tripplanner.firebaseapp.com",
            projectId: "wad2-tripplanner",
            storageBucket: "wad2-tripplanner.appspot.com",
            messagingSenderId: "1078917579599",
            appId: "1:1078917579599:web:d59344d7b81a0cb1e97b3a",
            databaseURL: "https://wad2-tripplanner-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // connect to the realtime database
        const db = getDatabase(app);

        // get a reference to the data 'title'
        const title = ref(db, 'title');

        // when value of 'title' changes, update to our <h1 id='target'>
        onValue(title, (snapshot) => {
            const data = snapshot.val(); // get the new value
            document.getElementById('target').innerText = data;
        });


        //Element Refereneces
        var name = document.getElementById("tripName")
        var days = document.getElementById("noDays")
        var addBtn = document.getElementById("insertBtn")

        //Insert Data
        function insertData(){
            //unique id (or also can use Date.now())
            var itinerary_id = push(child(ref(db), "AllItineraries")).key

            //main properties of itinerary: trip name, duration, image url
            set(ref(db, "/AllItineraries/" + loginUser.uid + "/" + itinerary_id), {
                ItineraryName: name.value,
                Days: days.value
            })

            //insert properties of each day's activities (CURRENTLY HARDCODED FOR VISUALISATION) <------------------------------------
            set(ref(db, "/AllItineraries/" + loginUser.uid + "/" + itinerary_id + "/itinerary/day1/activity1"), {
                act_name: "Dinner",
                time: "6pm - 7pm",
                address: "prinsep street"
            })

            set(ref(db, "/AllItineraries/" + loginUser.uid + "/" + itinerary_id + "/itinerary/day1/activity2"), {
                act_name: "travel to airport",
                time: "7pm - 8pm",
                address: "airport"
            })

            set(ref(db, "/AllItineraries/" + loginUser.uid + "/" + itinerary_id + "/itinerary/day2/activity1"), {
                act_name: "breakfast",
                time: "9am - 10am",
                address: "hotel"
            })

            set(ref(db, "/AllItineraries/" + loginUser.uid + "/" + itinerary_id + "/itinerary/day2/activity2"), {
                act_name: "free and easy",
                time: "10am - 12pm",
                address: "anywhere"
            })

            set(ref(db, "/AllItineraries/" + loginUser.uid + "/" + itinerary_id + "/itinerary/day2/activity3"), {
                act_name: "fun activity",
                time: "1pm - 5pm",
                address: "fun place"
            })


            .then(() => {
                alert("Data stored successfully!")
            })
            .catch((error) => {
                alert("unsuccessful, " + error)
            });
        }

        //Assign event listener
        addBtn.addEventListener('click', insertData)




        /* AUTHENTICATION CODE: START */ 
        import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-auth.js"; 
        
        const provider = new GoogleAuthProvider(); 
        const auth = getAuth(); 
        var loginUser = false; // Current Logged In User, false if not logged in.
        
        // when authentication status changed 
        onAuthStateChanged(auth, (user) => { 
            if (user) { 
                // User is signed in, see docs for a list of available properties 
                // https://firebase.google.com/docs/reference/js/firebase.User

                const uid = user.uid; 
                // ... 
                loginUser = user; 
                document.getElementById('login').innerText = `${user.displayName} (${user.email})`; 
                document.getElementById('plans').innerHTML = `<p>here are your trips</p>`


                //GET EACH ITINERARY UNDER CURRENT USER
                onValue(ref(db, 'AllItineraries/' + uid), (snapshot) => {

                    //console.log(snapshot.val())
                    var counter = 1

                    for(let itinerary_key in snapshot.val()){
                        var itinerary_obj = snapshot.val()[itinerary_key]
                        var itinerary = itinerary_obj.itinerary
                        

                        console.log(itinerary_obj)
                        console.log(itinerary)

                        
                        for(let day in itinerary){
                            

                            let day_activities = itinerary[day]
                            console.log(day_activities) // this logs every activity in the current day

                            for(let activity in day_activities){
                                console.log(day_activities[activity]) //this logs every activity in the list of activities in the current day
                                console.log(day_activities[activity].time)
                                console.log(day_activities[activity].act_name)
                                console.log(day_activities[activity].address)
                            }
                            

                        }


                        //(CURRENTLY HARDCODED FOR VISUALISATION) <----------------------------------------------
                        /*
                        document.getElementById('plans').innerHTML += 
                        `
                        <p>(Trip ${counter}) ${itinerary_key} <br>
                            Trip Name: ${itinerary_obj.ItineraryName} <br>
                            Duration: ${itinerary_obj.Days} <br>
                            Day1 <br>
                            Activity 1: ${acts.day1.activity1.act_name} ---- ${acts.day1.activity1.time} ---- ${acts.day1.activity1.address} <br>
                            Activity 2: ${acts.day1.activity2.act_name} ---- ${acts.day1.activity2.time} ---- ${acts.day1.activity2.address} <br>
                            
                            Day2 <br>
                            Activity 1: ${acts.day2.activity1.act_name} ---- ${acts.day2.activity1.time} ---- ${acts.day2.activity1.address} <br>
                            Activity 2: ${acts.day2.activity2.act_name} ---- ${acts.day2.activity2.time} ---- ${acts.day2.activity2.address} <br>
                            
                        </p>
                        `
                        */
                        counter += 1;
                    }

                })

                
            } else { 
                // User is signed out 
                // ... 
                loginUser = false; 
                document.getElementById('login').innerText = 'Not authenticated'; 
                document.getElementById('plans').innerHTML = `<p>Please login to view</p>`
            } 
        }); 




        // google login 
        document.getElementById('btnLogin').addEventListener('click', function () { 
            signInWithPopup(auth, provider)
                .then((result) => { 
                    // This gives you a Google Access Token. You can use it to access the Google API. 
                    const credential = GoogleAuthProvider.credentialFromResult(result); 
                    const token = credential.accessToken; 
                    // The signed-in user info. 
                    const user = result.user; 
                    // ... 
                    loginUser = user; 

                }).catch((error) => { 
                    // Handle Errors here. 
                    const errorCode = error.code; 
                    const errorMessage = error.message; 
                    // The email of the user's account used. 
                    const email = error.email; 
                    // The AuthCredential type that was used. 
                    const credential = GoogleAuthProvider.credentialFromError(error); 
                    // ... 
                    console.log(error);
                 });
            }); 
            
            // logout 
            document.getElementById('btnLogout') .addEventListener('click', function () { 
                signOut(auth).then(() => { 
                    // Sign-out successful.
                    loginUser = false; 
                
                }).catch((error) => { 
                    // An error happened. 
                    console.log(error);
                }); 
            }); /* AUTHENTICATION CODE: END */




    </script>


</body>
</html>